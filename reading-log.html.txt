<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>My Reading Log</title>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#f0d7e6;
      --accent:#ff4da6;
      --accent2:#7c3aed;
      --btn:#111827;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "PingFang SC", "Noto Sans CJK SC", Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 500px at 30% -10%, rgba(255,77,166,.20), transparent 60%),
        radial-gradient(900px 400px at 90% 0%, rgba(124,58,237,.14), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding: 18px 14px 40px;
    }
    .wrap{max-width:920px;margin:0 auto}
    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
      margin: 6px 2px 14px;
    }
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .pill{
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      font-size:15px;margin:0 0 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .hint{color:var(--muted);font-size:12px}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{border-color: rgba(255,77,166,.55); box-shadow: 0 0 0 4px rgba(255,77,166,.10)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stars{
      display:flex;gap:8px;align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      user-select:none;
    }
    .star{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.06);
      background: #fff;
      display:grid;place-items:center;
      font-size:18px;
      cursor:pointer;
      transition: transform .06s ease;
    }
    .star:active{transform: scale(.96)}
    .star.is-on{background: rgba(255,77,166,.12); border-color: rgba(255,77,166,.35)}
    .starHint{margin-left:auto;color:var(--muted);font-size:12px}

    .actions{
      display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      cursor:pointer;
      background: var(--btn);
      color:#fff;
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background:#fff;
      color: var(--ink);
      border:1px solid rgba(0,0,0,.08);
    }
    .btn.danger{
      background: var(--danger);
      color:#fff;
    }
    .btn.small{padding:8px 10px;font-size:12px}

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .stat{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:10px 10px;
      text-align:center;
    }
    .stat .n{font-size:18px;font-weight:800}
    .stat .t{font-size:12px;color:var(--muted);margin-top:2px}
    .backup-bar{
      display:flex;
      gap:10px;
      margin-top:10px;
      justify-content:flex-end;
    }

    table{width:100%;border-collapse:collapse}
    th, td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted);font-weight:700;text-align:left;font-size:12px}
    .col-no{width:46px}
    .col-stars{width:110px}
    .col-num{width:92px;text-align:center}
    .col-actions{width:140px;text-align:right}
    .stars-mini{letter-spacing:1px;color:#ff4da6;font-weight:800}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ“š Reading Log</h1>
        <div class="subtitle">è®°å½•ä¸€æœ¬ä¹¦çš„é˜…è¯»å¤©æ•°ã€æ€»æ—¶é•¿å’Œå–œçˆ±åº¦ï¼ˆ1â€“5â­ï¼‰</div>
      </div>
      <div class="pill">é€‚åˆå­©å­ï½œè½»é‡è®°å½•ï½œçœ‹å¾—è§ç§¯ç´¯</div>
    </header>

    <div class="grid">
      <!-- å·¦ï¼šè¡¨å• -->
      <section class="card">
        <h2>
          <span>â• æ·»åŠ è®°å½•</span>
          <span class="hint" id="modeHint">æ–°è®°å½•</span>
        </h2>

        <form id="bookForm">
          <input type="hidden" id="editingId" value="">

          <label>ä¹¦å</label>
          <input id="titleInput" autocomplete="off" placeholder="ä¾‹å¦‚ï¼šWho Wasâ€¦?" />

          <label>å–œçˆ±åº¦</label>
          <div class="stars" id="starPicker">
            <button class="star" type="button" data-value="1">â­</button>
            <button class="star" type="button" data-value="2">â­</button>
            <button class="star" type="button" data-value="3">â­</button>
            <button class="star" type="button" data-value="4">â­</button>
            <button class="star" type="button" data-value="5">â­</button>
            <div class="starHint" id="starHint">ç‚¹æ˜Ÿæ˜Ÿé€‰æ‹©ï¼ˆå¯ä¸é€‰ï¼‰</div>
          </div>

          <div class="row">
            <div>
              <label>é˜…è¯»å¤©æ•°ï¼ˆæ•°å­—ï¼‰</label>
              <input id="daysInput" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š2" />
            </div>
            <div>
              <label>é˜…è¯»æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
              <input id="minutesInput" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š35" />
            </div>
          </div>

          <div class="actions">
            <button id="submitBtn" class="btn" type="submit">æ·»åŠ åˆ°åˆ—è¡¨</button>
            <button id="resetBtn" class="btn ghost" type="button">æ¸…ç©ºè¾“å…¥</button>
            <button id="clearAllBtn" class="btn danger" type="button">æ¸…ç©ºå…¨éƒ¨</button>
          </div>
        </form>

        <div class="stats" aria-label="ç´¯è®¡ç»Ÿè®¡">
          <div class="stat">
            <div class="n" id="totalBooks">0</div>
            <div class="t">ç´¯è®¡æœ¬æ•°</div>
          </div>
          <div class="stat">
            <div class="n" id="totalDays">0</div>
            <div class="t">ç´¯è®¡å¤©æ•°</div>
          </div>
          <div class="stat">
            <div class="n"><span id="totalMinutes">0</span><span class="muted" id="totalPretty"></span></div>
            <div class="t">ç´¯è®¡æ—¶é•¿</div>
          </div>
        </div>

        <div class="backup-bar">
          <button id="backupBtn" class="btn ghost small" type="button">ğŸ“¤ å¤‡ä»½</button>
          <button id="restoreBtn" class="btn ghost small" type="button">ğŸ“¥ æ¢å¤</button>
        </div>

        <div class="hint" style="margin-top:8px;">
          æç¤ºï¼šå¤‡ä»½ç”¨äºé˜²æ­¢ iOS å¶å°”æ¸…ç†æ•°æ®ï¼ˆä¸€èˆ¬ä¸ç”¨é¢‘ç¹æ“ä½œï¼‰ã€‚
        </div>
      </section>

      <!-- å³ï¼šåˆ—è¡¨ -->
      <section class="card">
        <h2>ğŸ“’ è®°å½•åˆ—è¡¨ <span class="hint">å¯ç¼–è¾‘ / åˆ é™¤</span></h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th class="col-no">#</th>
                <th>ä¹¦å</th>
                <th class="col-stars">å–œçˆ±åº¦</th>
                <th class="col-num">å¤©æ•°</th>
                <th class="col-num">åˆ†é’Ÿ</th>
                <th class="col-actions">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:10px;">
          ç¼–è¾‘ï¼šç‚¹å‡»â€œç¼–è¾‘â€åä¼šè‡ªåŠ¨å›å¡«åˆ°å·¦ä¾§è¡¨å•ï¼ŒæŒ‰é’®ä¼šå˜æˆâ€œä¿å­˜ä¿®æ”¹â€ã€‚
        </div>
      </section>
    </div>
  </div>

  <script>
  (() => {
    const STORAGE_KEY = "kid_reading_star_log_v1";
    let started = false;

    function $(id) { return document.getElementById(id); }

    function clampInt(value) {
      if (value === "" || value === null || typeof value === "undefined") return 0;
      const n = Number(value);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.floor(n));
    }

    function escapeHtml(str) {
      const s = String(str);
      return s
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function prettyMinutes(min) {
      const m = clampInt(min);
      const h = Math.floor(m / 60);
      const r = m % 60;
      return `${h}h ${r}m`;
    }

    function starsText(rating) {
      const r = Math.min(5, clampInt(rating));
      if (!r) return '<span class="muted">â€”</span>';
      return `<span class="stars-mini">${"â˜…".repeat(r)}${"â˜†".repeat(5 - r)}</span>`;
    }

    function uid() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function safeSave(books) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
        return true;
      } catch {
        return false;
      }
    }

    function safeLoad() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr
          .map((x) => ({
            id: String(x.id || uid()),
            title: String(x.title || "").trim(),
            days: clampInt(x.days),
            minutes: clampInt(x.minutes),
            rating: clampInt(x.rating),
            createdAt: Number(x.createdAt || Date.now()),
          }))
          .filter((x) => x.title.length > 0);
      } catch {
        return [];
      }
    }

    function startWhenReady() {
      if (started) return;

      const required = [
        "bookForm","titleInput","daysInput","minutesInput",
        "editingId","submitBtn","resetBtn","clearAllBtn",
        "listBody","totalBooks","totalDays","totalMinutes",
        "totalPretty","starPicker","starHint","modeHint",
        "backupBtn","restoreBtn"
      ];

      const missing = required.filter((id) => !$(id));
      if (missing.length) {
        setTimeout(startWhenReady, 60);
        return;
      }

      started = true;
      initApp();
    }

    function initApp() {
      const els = {
        form: $("bookForm"),
        title: $("titleInput"),
        days: $("daysInput"),
        minutes: $("minutesInput"),
        editingId: $("editingId"),
        submitBtn: $("submitBtn"),
        resetBtn: $("resetBtn"),
        clearAllBtn: $("clearAllBtn"),
        listBody: $("listBody"),
        totalBooks: $("totalBooks"),
        totalDays: $("totalDays"),
        totalMinutes: $("totalMinutes"),
        totalPretty: $("totalPretty"),
        starPicker: $("starPicker"),
        starHint: $("starHint"),
        modeHint: $("modeHint"),
        backupBtn: $("backupBtn"),
        restoreBtn: $("restoreBtn"),
      };

      const state = {
        books: safeLoad(),
        currentRating: 0,
      };

      // iOS ç¯å¢ƒå¶å°”ä¼šç¦ç”¨æŒä¹…åŒ–ï¼›è¿™é‡Œä¸ä¼šé˜»æ­¢ä½¿ç”¨
      safeSave(state.books);

      function setModeText() {
        els.modeHint.textContent = els.editingId.value ? "ç¼–è¾‘ä¸­" : "æ–°è®°å½•";
      }

      function setRating(v) {
        state.currentRating = Math.min(5, clampInt(v));
        const stars = els.starPicker.querySelectorAll(".star");
        stars.forEach((btn) => {
          const val = clampInt(btn.dataset.value);
          btn.classList.toggle("is-on", state.currentRating > 0 && val <= state.currentRating);
        });
        els.starHint.textContent = state.currentRating
          ? `å·²é€‰æ‹©ï¼š${state.currentRating} æ˜Ÿï¼ˆå†ç‚¹å¯å–æ¶ˆï¼‰`
          : "ç‚¹æ˜Ÿæ˜Ÿé€‰æ‹©ï¼ˆå¯ä¸é€‰ï¼‰";
      }

      function resetForm() {
        els.form.reset();
        els.editingId.value = "";
        els.submitBtn.textContent = "æ·»åŠ åˆ°åˆ—è¡¨";
        setRating(0);
        setModeText();
        els.title.focus();
      }

      function render() {
        els.listBody.innerHTML = "";
        state.books
          .sort((a, b) => a.createdAt - b.createdAt)
          .forEach((b, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="col-no"><strong>${idx + 1}</strong></td>
              <td>${escapeHtml(b.title)}</td>
              <td class="col-stars">${starsText(b.rating)}</td>
              <td class="col-num">${b.days || 0}</td>
              <td class="col-num">${b.minutes || 0}</td>
              <td class="col-actions">
                <button class="btn ghost small" type="button" data-action="edit" data-id="${b.id}">ç¼–è¾‘</button>
                <button class="btn danger small" type="button" data-action="del" data-id="${b.id}">åˆ é™¤</button>
              </td>
            `;
            els.listBody.appendChild(tr);
          });

        const totalBooks = state.books.length;
        const totalDays = state.books.reduce((s, b) => s + clampInt(b.days), 0);
        const totalMinutes = state.books.reduce((s, b) => s + clampInt(b.minutes), 0);

        els.totalBooks.textContent = String(totalBooks);
        els.totalDays.textContent = String(totalDays);
        els.totalMinutes.textContent = String(totalMinutes);
        els.totalPretty.textContent = ` (${prettyMinutes(totalMinutes)})`;
      }

      function saveAndRender() {
        safeSave(state.books);
        render();
      }

      function addOrSave() {
        const title = (els.title.value || "").trim();
        if (!title) {
          els.title.focus();
          return;
        }

        const days = clampInt(els.days.value);
        const minutes = clampInt(els.minutes.value);
        const rating = clampInt(state.currentRating);
        const editingId = (els.editingId.value || "").trim();

        if (editingId) {
          const i = state.books.findIndex((x) => x.id === editingId);
          if (i >= 0) {
            state.books[i] = {
              ...state.books[i],
              title,
              days,
              minutes,
              rating: Math.min(5, rating),
            };
          }
          saveAndRender();
          resetForm();
          els.listBody.scrollIntoView({ behavior: "smooth", block: "start" });
          return;
        }

        state.books.push({
          id: uid(),
          title,
          days,
          minutes,
          rating: Math.min(5, rating),
          createdAt: Date.now(),
        });

        saveAndRender();
        resetForm();
        els.listBody.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // æ˜Ÿæ˜Ÿé€‰æ‹©
      els.starPicker.addEventListener("click", (e) => {
        const btn = e.target.closest(".star");
        if (!btn) return;
        const v = clampInt(btn.dataset.value);
        if (state.currentRating === v) setRating(0);
        else setRating(v);
      });

      // submit + click + touchend + pointerupï¼ˆiOS å…¼å®¹ï¼‰
      els.form.addEventListener("submit", (e) => {
        e.preventDefault();
        addOrSave();
      });

      els.submitBtn.addEventListener("click", (e) => {
        e.preventDefault();
        addOrSave();
      }, { passive: false });

      els.submitBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        addOrSave();
      }, { passive: false });

      els.submitBtn.addEventListener("pointerup", (e) => {
        e.preventDefault();
        addOrSave();
      }, { passive: false });

      els.resetBtn.addEventListener("click", resetForm);

      els.clearAllBtn.addEventListener("click", () => {
        if (state.books.length === 0) return;
        if (!confirm("ç¡®å®šæ¸…ç©ºå…¨éƒ¨è®°å½•å—ï¼Ÿæ¸…ç©ºåæ— æ³•æ¢å¤ã€‚")) return;
        state.books = [];
        saveAndRender();
        resetForm();
      });

      // ç¼–è¾‘ / åˆ é™¤
      els.listBody.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;
        const book = state.books.find((x) => x.id === id);
        if (!book) return;

        if (action === "edit") {
          els.title.value = book.title;
          els.days.value = book.days ? String(book.days) : "";
          els.minutes.value = book.minutes ? String(book.minutes) : "";
          els.editingId.value = book.id;
          els.submitBtn.textContent = "ä¿å­˜ä¿®æ”¹";
          setRating(book.rating || 0);
          setModeText();
          els.title.focus();
          return;
        }

        if (action === "del") {
          if (!confirm(`ç¡®å®šåˆ é™¤ã€Š${book.title}ã€‹å—ï¼Ÿ`)) return;
          state.books = state.books.filter((x) => x.id !== id);
          saveAndRender();
          if (els.editingId.value === id) resetForm();
        }
      });

      // ===== å¤‡ä»½ / æ¢å¤ =====
      els.backupBtn.addEventListener("click", async () => {
        const data = localStorage.getItem(STORAGE_KEY) || "[]";
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(data);
            alert("âœ… å·²å¤‡ä»½åˆ°å‰ªè´´æ¿ã€‚\nè¯·ç²˜è´´ä¿å­˜åˆ°å¤‡å¿˜å½• / iCloud Notes / å¾®ä¿¡æ”¶è—ã€‚");
          } else {
            prompt("è¯·å¤åˆ¶ä¸‹é¢çš„å¤‡ä»½å†…å®¹ï¼š", data);
          }
        } catch {
          prompt("è¯·å¤åˆ¶ä¸‹é¢çš„å¤‡ä»½å†…å®¹ï¼š", data);
        }
      });

      els.restoreBtn.addEventListener("click", () => {
        const input = prompt("è¯·ç²˜è´´å¤‡ä»½å†…å®¹ï¼š");
        if (!input) return;

        try {
          const parsed = JSON.parse(input);
          if (!Array.isArray(parsed)) throw new Error("bad format");
          localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
          state.books = safeLoad();
          saveAndRender();
          resetForm();
          alert("âœ… æ¢å¤æˆåŠŸï¼");
        } catch {
          alert("âŒ æ¢å¤å¤±è´¥ï¼šå†…å®¹æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
      });

      // init
      setRating(0);
      setModeText();
      render();
    }

    startWhenReady();
  })();
  </script>
</body>
</html>